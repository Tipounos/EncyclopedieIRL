<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <title>Encyclop√©die IRL - COCO-SSD</title>

  <!-- TFJS + COCO-SSD (meilleure d√©tection objets) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>

  <style>
    :root{
      --accent:#ffcc00;
      --bg1:#1b1b1b;
      --bg2:#2c2c2c;
      --card:#222;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(to bottom, var(--bg1), var(--bg2));
      margin: 0;
      color: #fff;
      display:flex;
      flex-direction:column;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      text-shadow: 1px 1px 5px #000;
      margin: 14px 8px;
      font-size: clamp(20px, 4vw, 28px);
    }

    /* zone cam√©ra + bouton */
    .top {
      width: 100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      padding: 0 12px 8px;
    }

    .camera-wrapper {
      position: relative;
      width: min(92vw, 420px);
      margin: 0 auto;
      padding: clamp(10px, 2.5vw, 20px);
      background: url('background.png') center/cover no-repeat, #111;
      border-radius: 16px;
      box-shadow: 0 0 18px var(--accent);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* video responsive */
    video {
      width: 100%;
      height: auto;
      aspect-ratio: 4/3;
      background:#000;
      border-radius: 12px;
      display: block;
    }

    .controls{
      display:flex;
      gap:10px;
      width:min(92vw, 420px);
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }

    button {
      padding: 12px 18px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: var(--accent);
      color: #111;
      box-shadow: 0 0 10px var(--accent);
      transition: transform .15s ease, box-shadow .15s ease, background .2s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 0 14px var(--accent); }
    button:active { transform: translateY(0); }

    .hint {
      font-size: .9rem;
      opacity:.9;
      text-align:center;
      margin-top: -4px;
    }

    /* zone collection scrollable */
    .collection-wrap{
      flex:1 1 auto;
      min-height:0; /* crucial pour que le scroll prenne tout l‚Äôespace restant */
      display:flex;
      flex-direction:column;
      padding: 4px 8px 8px;
    }

    h2 {
      text-align:center;
      color: var(--accent);
      margin: 6px 0 8px;
      font-size: clamp(16px, 3.5vw, 22px);
    }

    #collection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 12px;
      padding: 8px 6px 90px; /* gros padding-bottom pour voir la derni√®re rang√©e */
      overflow-y: auto;       /* scroll fluide */
      border-top: 1px solid rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    #collection::-webkit-scrollbar{ width: 8px; }
    #collection::-webkit-scrollbar-thumb{ background: var(--accent); border-radius: 4px; }
    #collection::-webkit-scrollbar-track{ background: #111; border-radius: 4px; }

    .entry {
      background: var(--card);
      padding: 10px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap:8px;
      transition: transform 0.18s, box-shadow 0.18s;
      box-shadow: 0 0 5px #000;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .entry:hover { transform: translateY(-3px); box-shadow: 0 0 12px var(--accent); }

    .entry img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid var(--accent);
      background:#000;
    }
    .entry .name {
      font-size: .95rem;
      text-align: center;
      line-height:1.2;
    }
    .entry .score {
      font-size: .8rem;
      opacity:.8;
    }

    /* Cin√©matique */
    #cinematic {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: min(92vw, 380px);
      background: rgba(0,0,0,0.85);
      border: 2px solid var(--accent);
      border-radius: 16px;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 16px;
      gap:10px;
    }
    #cinematic.show {
      display:flex;
      animation: pop .45s ease forwards;
    }
    @keyframes pop {
      0% { transform: translate(-50%, -50%) scale(0.6); opacity:0 }
      60%{ transform: translate(-50%, -50%) scale(1.05); opacity:1 }
      100%{ transform: translate(-50%, -50%) scale(1) }
    }
    #cinematic img {
      width: min(60vw, 140px);
      aspect-ratio: 1;
      border-radius: 12px;
      border: 2px solid var(--accent);
      background:#000;
    }
    #cinematic b {
      font-size: 1.1rem;
      color: var(--accent);
      text-shadow: 1px 1px 5px black;
      text-align:center;
    }

    /* Popup */
    #popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
      padding: 14px;
    }
    #popup-content {
      background: var(--card);
      padding: 18px;
      border-radius: 16px;
      text-align: center;
      width: min(92vw, 620px);
      max-height: 85vh;
      overflow-y: auto;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }
    #popup-content img {
      width: min(80vw, 360px);
      max-width: 100%;
      border-radius: 12px;
      border: 2px solid var(--accent);
      margin-bottom: 10px;
      background:#000;
    }
    #popup-content h2 {
      color: var(--accent);
      margin: 8px 0 6px;
      line-height:1.2;
    }
    #popup-content p {
      color: #f0f0f0;
      text-align:left;
      white-space:pre-wrap;
    }
    #popup-close {
      margin-top: 14px;
      padding: 10px 16px;
      background: var(--accent);
      color: #111;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 800;
    }

    /* petits √©crans: resserrer la grille */
    @media (max-width: 420px){
      #collection{ grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
    }
  </style>
</head>
<body>

  <h1>üì∏ Encyclop√©die IRL</h1>

  <div class="top">
    <div class="camera-wrapper">
      <!-- playsinline + muted aident iOS √† ne pas passer en plein √©cran -->
      <video id="camera" autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <button id="captureBtn">Scanner</button>
      <button id="switchCamBtn" title="Basculer cam√©ra">üîÅ Cam√©ra</button>
    </div>
    <div class="hint">Astuce : utilise en HTTPS + accepte la permission cam√©ra. Sur mobile, on force la cam√©ra arri√®re.</div>
  </div>

  <div class="collection-wrap">
    <h2>üìö Ma collection</h2>
    <div id="collection"></div>
  </div>

  <!-- Cin√©matique -->
  <div id="cinematic">
    <img id="cinematic-img" alt="">
    <b id="cinematic-name"></b>
  </div>

  <!-- Popup -->
  <div id="popup">
    <div id="popup-content">
      <img id="popup-img" alt="">
      <h2 id="popup-name"></h2>
      <p id="popup-desc">Chargement‚Ä¶</p>
      <button id="popup-close">Fermer</button>
    </div>
  </div>

<script>
let model;                 // COCO-SSD
let encyclopedia = [];     // { id, name, score, img, labels[] }
let currentStream = null;
let useBackCamera = true;  // cam√©ra arri√®re par d√©faut

// petites corrections nom -> FR pour Wikipedia fr
const labelCorrections = {
  "cell phone": "smartphone",
  "tv": "t√©l√©vision",
  "backpack": "sac √† dos",
  "couch": "canap√©",
  "bottle": "bouteille",
  "cup": "tasse",
  "bird": "oiseau",
  "cat": "chat",
  "dog": "chien",
  "laptop": "ordinateur portable",
  "keyboard": "clavier",
  "mouse": "souris",
  "remote": "t√©l√©commande",
  "sports ball": "ballon de sport",
  "dining table": "table √† manger"
};

async function init() {
  try {
    model = await cocoSsd.load(); // charge COCO-SSD
    console.log("‚úÖ COCO-SSD pr√™t");
  } catch (e) {
    console.error("Erreur mod√®le :", e);
    alert("Erreur lors du chargement du mod√®le. Recharge la page.");
    return;
  }
  await startCamera();
}

async function startCamera() {
  // stop anciens tracks si on switch
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());

  const constraints = {
    audio: false,
    video: {
      facingMode: useBackCamera ? { ideal: "environment" } : "user",
      width: { ideal: 1280 },
      height: { ideal: 720 }
    }
  };

  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    currentStream = stream;
    const video = document.getElementById("camera");
    video.srcObject = stream;
    await video.play();
  } catch (e) {
    console.error("Erreur cam√©ra :", e);
    alert("Impossible d'acc√©der √† la cam√©ra. V√©rifie les permissions et que le site est en HTTPS.");
  }
}

document.getElementById("switchCamBtn").addEventListener("click", async () => {
  useBackCamera = !useBackCamera;
  await startCamera();
});

document.getElementById("captureBtn").addEventListener("click", async () => {
  const video = document.getElementById("camera");
  if (!model || !video.videoWidth) {
    alert("Cam√©ra ou mod√®le non pr√™t.");
    return;
  }

  // capture frame
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // d√©tection objets (plus fiable que MobileNet)
  let detections = [];
  try {
    detections = await model.detect(canvas);
  } catch (e) {
    console.error("Erreur detection:", e);
    alert("Erreur de d√©tection. R√©essaie.");
    return;
  }

  if (!detections.length) {
    alert("Rien d√©tect√© üòÖ");
    return;
  }

  // garder la meilleure d√©tection (score max) pour l‚Äôencyclop√©die
  detections.sort((a,b)=> b.score - a.score);
  const top = detections[0];
  const scorePct = Math.round(top.score * 100);
  const rawName = top.class; // ex: "dining table"
  const bestName = (labelCorrections[rawName] || rawName).trim();

  // stocker l'image + labels alternatifs (top 3)
  const labels = detections.slice(0,3).map(d => (labelCorrections[d.class] || d.class));
  const id = bestName.toLowerCase();

  // remonter si d√©j√† pr√©sent
  encyclopedia = encyclopedia.filter(e => e.id !== id);
  encyclopedia.unshift({
    id,
    name: bestName,
    score: scorePct,
    img: canvas.toDataURL("image/jpeg", 0.9),
    labels
  });

  updateCollection();

  // Cin√©matique
  showCinematic( encyclopedia[0].img, `${bestName} (${scorePct}%)` );
});

function showCinematic(img, name){
  const c = document.getElementById("cinematic");
  document.getElementById("cinematic-img").src = img;
  document.getElementById("cinematic-name").textContent = name;
  c.classList.add("show");
  setTimeout(()=> c.classList.remove("show"), 1800);
}

// Update UI liste
function updateCollection() {
  const container = document.getElementById("collection");
  container.innerHTML = "";
  encyclopedia.forEach(item => {
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `
      <img src="${item.img}" alt="">
      <div class="name">${item.name}</div>
      <div class="score">Confiance: ${item.score}%</div>
    `;
    container.appendChild(div);

    // open popup on click
    div.addEventListener("click", () => openPopup(item));
  });
}

async function openPopup(item){
  document.getElementById("popup-img").src = item.img;
  document.getElementById("popup-name").textContent = item.name;
  const descEl = document.getElementById("popup-desc");
  descEl.textContent = "Chargement‚Ä¶";

  // On tente : 1) label FR corrig√©, 2) label brut, 3) 2e/3e labels, 4) fallback EN
  const tryLabels = [];
  // priorit√© au label principal + variantes
  tryLabels.push(item.name);
  const rawFirst = item.labels?.[0] || item.name;
  if (!tryLabels.includes(rawFirst)) tryLabels.push(rawFirst);
  // autres candidats
  (item.labels || []).slice(1,3).forEach(l=>{
    if(!tryLabels.includes(l)) tryLabels.push(l);
  });

  let description = null;
  // Essayons fr.wikipedia
  for (const q of tryLabels){
    const cleaned = q.replace(/_/g, " ").split(",")[0].trim();
    const ok = await fetchSummary(cleaned, "fr");
    if (ok){ description = ok; break; }
  }
  // fallback en.wikipedia si rien en FR
  if (!description){
    for (const q of tryLabels){
      const cleaned = q.replace(/_/g, " ").split(",")[0].trim();
      const ok = await fetchSummary(cleaned, "en");
      if (ok){ description = ok; break; }
    }
  }

  descEl.textContent = description || "Aucune description disponible.";

  document.getElementById("popup").style.display = "flex";
}

async function fetchSummary(term, lang){
  try{
    const resp = await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`);
    if(!resp.ok) return null;
    const data = await resp.json();
    if (data && data.extract) return data.extract;
    return null;
  }catch(e){ return null; }
}

document.getElementById("popup-close").addEventListener("click", ()=>{
  document.getElementById("popup").style.display = "none";
});

init();
</script>
</body>
</html>
